# DataBao 平台整体架构

> DataBao 加密货币数据处理平台的系统架构和组件设计

## 📋 架构概览

DataBao是一个完整的加密货币数据处理平台，采用模块化架构设计，由四个核心组件组成，通过数据库和消息机制实现松耦合集成。

## 🏗️ 系统架构图

```
                    DataBao 生产环境架构
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据流向                                      │   │
│  │                                                                     │   │
│  │  远程PostgreSQL ──▶ DataSync ──▶ DataInsight ──▶ DataView          │   │
│  │  (95.216.186.216)  (数据同步)   (指标计算)      (前端展示)          │   │
│  │         │              │            │               │                │   │
│  │         │              ▼            ▼               ▼                │   │
│  │         │         本地cryptodb   indicator_data  Web界面             │   │
│  │         │       (分层存储架构)    (指标存储)    (用户交互)            │   │
│  │         │                                                             │   │
│  │         └─────────────────┐                                           │   │
│  │                           ▼                                           │   │
│  │                    Monitor Service                                    │   │
│  │                   (统一监控告警)                                       │   │
│  │                           │                                           │   │
│  │                           ▼                                           │   │
│  │                   飞书/Slack/邮件                                      │   │
│  │                    (多渠道通知)                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 核心组件

### 1. DataSync - 数据同步引擎
**职责**: 数据获取和管理
- **数据同步**: 每3分钟从远程PostgreSQL同步最新数据
- **分层存储**: 热数据(SSD) + 温数据(HDD) + 冷数据(备份盘)
- **数据清理**: 自动清理远程数据库过期数据，释放存储空间
- **数据迁移**: 定期将热数据迁移到温/冷存储

### 2. DataInsight - 指标计算引擎  
**职责**: 数据分析和指标计算
- **简化调度**: 基于3秒轮询 + 5秒安全缓冲的简化高效调度器
- **高效计算**: 一次查询9个时间点，内存计算16个指标，批量保存
- **准实时响应**: 每3秒检查新数据，发现后等待5秒确保数据完整性
- **连续追赶**: 启动时自动连续计算所有滞后数据块

### 3. DataView - 前端展示系统 ✅
**职责**: 用户界面和数据可视化
- **数据展示**: Next.js 15前端 + FastAPI后端，展示实时币种数据
- **用户交互**: 支持搜索、分页、排序等交互功能
- **高性能API**: 优化数据库查询，支持大规模数据展示
- **多设备支持**: 响应式设计，支持PC和移动端

### 4. Monitor - 统一监控系统
**职责**: 系统监控和告警管理
- **事件收集**: 收集所有组件的运行事件和指标
- **智能路由**: 根据事件类型和级别路由到不同通知渠道
- **多渠道通知**: 支持飞书、Slack、邮件、短信等多种通知方式
- **Web管理**: 提供监控面板和配置管理界面

## 💾 数据架构

### 分层存储策略

DataBao采用三层存储架构，平衡性能和成本：

```
                        数据分层存储架构
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  📊 热数据层 (Hot Data)                                      │
│  ├─ 存储介质: 3.7TB NVMe SSD                                │
│  ├─ 数据范围: 最近6个月的数据                                 │
│  ├─ 挂载点: /databao_hot                                    │
│  ├─ 查询性能: 超高速（毫秒级）                                │
│  └─ 使用场景: 实时查询、API响应、前端展示                     │
│                                                             │
│  🗂️ 温数据层 (Warm Data)                                    │
│  ├─ 存储介质: 7.2TB SATA HDD                               │
│  ├─ 数据范围: 6个月-4年的历史数据                            │
│  ├─ 挂载点: /databao_warm                                  │
│  ├─ 查询性能: 中等（秒级）                                   │
│  └─ 使用场景: 历史分析、趋势计算、报表生成                     │
│                                                             │
│  ❄️ 冷数据层 (Cold Data)                                    │
│  ├─ 存储介质: 19TB SATA HDD                                │
│  ├─ 数据范围: 4年以上数据 + 备份                             │
│  ├─ 挂载点: /databao_cold                                  │
│  ├─ 查询性能: 较慢（分钟级）                                 │
│  └─ 使用场景: 长期归档、合规要求、灾难恢复                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 数据库设计

**主数据库: cryptodb**

```sql
-- 币种数据（分区表）
coin_data
├── coin_data_hot      (SSD - 最近6个月)
├── coin_data_warm     (HDD - 6个月-4年)  
└── coin_data_cold     (备份盘 - 4年以上)

-- 指标数据（分区表）
indicator_data
├── indicator_data_hot
├── indicator_data_warm  
└── indicator_data_cold

-- 管理表
sync_logs              (同步日志)
cleanup_logs           (清理日志) 
migration_logs         (迁移日志)
```

## 🔄 数据流架构

### 数据同步流程

```
1. 远程数据获取
   ├─ 连接远程PostgreSQL (95.216.186.216)
   ├─ 增量查询新数据（基于时间戳）
   ├─ 批量读取（10,000条/批次）
   └─ SSL加密传输

2. 本地数据存储  
   ├─ 写入热数据分区（SSD）
   ├─ 数据完整性校验
   ├─ 发送NOTIFY通知给DataInsight
   └─ 记录同步日志

3. 远程数据清理
   ├─ 验证本地数据完整性
   ├─ 删除远程60天以上数据
   ├─ 记录清理日志
   └─ 发送监控事件

4. 数据分层迁移
   ├─ 热数据 → 温数据（6个月后）
   ├─ 温数据 → 冷数据（4年后）
   ├─ 后台定期执行
   └─ 记录迁移日志
```

### 指标计算流程

```
1. 简化调度轮询
   ├─ 每3秒检查数据库最新时间
   ├─ 对比indicator_data最后时间
   └─ 发现新数据后触发计算

2. 安全缓冲等待
   ├─ 首次发现新数据等待5秒
   ├─ 确保DataSync完成4000条数据写入
   └─ 避免数据不完整的计算

3. 高效批量计算
   ├─ 一次查询9个关键时间点数据
   ├─ 内存计算16个指标（11个基础+5个聚合）
   ├─ 批量写入indicator_data表
   └─ 约2秒完成45,000个指标结果

4. 连续追赶模式
   ├─ 连续计算所有滞后数据块
   ├─ 发送监控事件通知计算完成
   ├─ 更新计算状态
   └─ 继续3秒轮询等待
```

## 🔗 组件通信

### 通信机制

**1. 数据库轮询**
- DataInsight: 每3秒轮询数据库检查新数据
- 极轻量查询，数据库负载可忽略
- 简化架构，避免通知机制复杂性

**2. HTTP API**
- 各组件 → Monitor: 监控事件发送
- REST API: `POST http://localhost:9527/api/events`
- 异步发送，不阻塞业务逻辑

**3. 文件系统**
- 分层存储的数据访问
- 数据库分区自动路由
- 透明的存储层切换

### 服务依赖关系

```
PostgreSQL (基础服务)
    ↓
DataSync (数据源)
    ├─ 数据写入 ──→ DataInsight (3秒轮询检查)
    └─ HTTP ────→ Monitor (监控收集)
                      ↓
                 DataView ✅ (数据展示)
                      ↓  
                 用户界面 (Web/Mobile)
```

## ⚙️ 部署架构

### SystemD服务架构

所有组件统一使用SystemD管理，确保服务可靠性：

```
systemd 服务管理
├── postgresql.service          (数据库服务)
├── datasync.service           (数据同步服务)
├── datainsight.service        (指标计算服务)
├── databao-monitor.service    (监控服务)  
└── dataview.service           (前端服务, 待创建)

服务依赖关系:
├── postgresql → datasync → datainsight
├── postgresql → databao-monitor
└── datainsight → dataview (未来)
```

### 网络架构

```
外部网络:
├── 远程PostgreSQL (95.216.186.216:5432) - 数据源
├── 飞书Webhook API - 监控通知
└── 其他第三方API (按需)

内部网络:
├── localhost:5432  - 本地PostgreSQL
├── localhost:9527  - Monitor API服务
├── localhost:3000  - DataView Web服务 (待创建)
└── 内部进程通信 - PostgreSQL NOTIFY/LISTEN
```

## 🔒 安全架构

### 访问控制
- **数据库安全**: SSL连接 + 用户权限隔离
- **文件权限**: 600(配置) + 644(日志) + 755(数据)  
- **进程隔离**: 专用用户运行 + systemd沙箱
- **网络安全**: 本地服务 + 防火墙规则

### 数据保护
- **传输加密**: 远程连接强制TLS
- **访问日志**: 完整的数据访问记录
- **备份策略**: 三层存储 + 定期备份验证
- **恢复机制**: 分层恢复 + 增量备份

## 🔧 运维特性 (2025-09-09 更新)

### 自动重启机制
- **DataSync**: 每30分钟自动重启，避免连接池和网络问题积累
- **DataInsight**: 每30分钟自动重启，确保内存和计算状态清理
- **实现方式**: systemd `RuntimeMaxSec=1800` 配置
- **优势**: 系统级管理，无需外部脚本，高可靠性

### 网络代理支持
- **代理配置**: 支持http/https/socks5代理
- **环境变量**: 自动从systemd服务配置读取
- **适用场景**: 企业网络环境或需要代理访问的部署

### 故障恢复机制
- **追赶模式**: DataSync自动连续同步积压数据
- **断点续传**: 基于时间戳的增量同步
- **数据完整性**: 自动验证和修复机制

## 📊 性能特征

### 关键指标
- **数据同步延迟**: < 3分钟
- **指标计算延迟**: < 8秒（3秒检查 + 5秒安全缓冲）
- **查询响应时间**: 热数据 < 100ms, 温数据 < 1s
- **计算性能**: 2秒完成45,000个指标结果
- **系统可用性**: > 99.9%
- **存储效率**: 自动分层 + 压缩存储

### 扩展能力
- **水平扩展**: 支持多实例部署
- **垂直扩展**: 支持硬件升级
- **模块化扩展**: 插件式指标计算
- **存储扩展**: 分层存储可独立扩展

---

*最后更新: 2025-09-07*  
*版本: v2.1*  
*维护者: DataBao团队*