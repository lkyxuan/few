# 更新日志

## 2025-10-23 - TimescaleDB 兼容性修复

### 🔧 TimescaleDB 版本兼容性
- **问题修复**: 解决了 TimescaleDB 版本不匹配问题
  - PostgreSQL 期望版本 2.19.3，但系统安装的是 2.17.2
  - 添加智能版本检测和自动回退机制
  - 支持多个 TimescaleDB 版本的自动尝试

- **代码改进**:
  - 修改 `init_timescaledb.py` 添加版本兼容性处理
  - 自动尝试已安装的版本：2.17.2, 2.19.3, 2.16.1 等
  - 失败时自动回退到标准 PostgreSQL 表
  - 改进错误处理和日志记录

- **验证结果**:
  - TimescaleDB 2.17.2 扩展成功创建
  - 超表 (hypertable) 创建成功
  - 所有索引和视图正常工作
  - 数据采集脚本可正常运行

### 📚 文档更新
- **故障排除文档**: 创建 `TIMESCALEDB_TROUBLESHOOTING.md`
  - 详细的 TimescaleDB 安装和配置指南
  - 常见问题解决方案
  - 版本兼容性说明

## 2024-10-21 - 重大架构重构

### 🏗️ 架构重构
- **模块化重构**: 将原本的单文件 `coingecko_collector.py` 拆分为多个模块，提高代码可维护性和可扩展性
  - `config.py`: 集中管理所有配置项（数据库、API、Webhook等）
  - `data_fetcher.py`: 负责从CoinGecko API获取数据的逻辑
  - `database.py`: 数据库操作相关功能
  - `utils.py`: 工具函数（时间处理、状态报告、Webhook通知等）
  - `main.py`: 主程序入口和调度逻辑

### 🗄️ 数据库结构优化
- **时间戳格式变更**: 将所有时间字段从 `TIMESTAMPTZ` 改为 `BIGINT` 类型，使用Unix毫秒时间戳
  - `time`: 对齐到3分钟的毫秒时间戳（主键）
  - `raw_time`: 原始采集时间的毫秒时间戳
  - `last_updated`: API数据最后更新时间的毫秒时间戳
  - `created_at`: 数据行创建时间的毫秒时间戳

- **字段精度提升**:
  - `current_price`: 精度从 `DECIMAL(40,8)` 提升到 `DECIMAL(40,18)`
  - `coin_id` 和 `symbol`、`name` 字段长度从 `VARCHAR(50)` 扩展到 `VARCHAR(255)`

- **索引优化**:
  - 新增 `idx_coin_data_time_desc` 降序时间索引
  - 保留原有的币种ID、市值排名、原始时间索引

### 📊 数据库视图改进
- **latest_prices 视图**: 使用毫秒时间戳筛选过去10分钟内的最新数据
- **price_changes_24h 视图**: 
  - 改用毫秒时间戳进行24小时价格变化计算
  - 增加除零保护，避免计算错误
  - 优化时间窗口查询性能

### 🔧 功能增强
- **错误处理改进**: 
  - 更详细的异常信息记录
  - 改进的重试机制和指数退避策略
  - 更好的数据验证逻辑

- **时间处理优化**:
  - 统一使用毫秒时间戳处理所有时间相关操作
  - 改进的3分钟对齐算法
  - 更准确的时区处理（UTC+8）

- **数据验证增强**:
  - 改进的批次数据验证逻辑
  - 更严格的币种数据完整性检查
  - 数据库保存后的验证机制

### 🚀 性能优化
- **模块化加载**: 按需导入模块，减少启动时间
- **连接池优化**: 改进的数据库连接管理
- **查询优化**: 使用毫秒时间戳提高查询性能

### 🔧 配置管理
- **集中配置**: 所有配置项统一管理在 `config.py` 中
- **环境变量支持**: 更好的环境变量处理和默认值设置
- **API密钥管理**: 改进的CoinGecko API密钥处理逻辑

### 📝 代码质量
- **类型提示**: 增加更多的类型注解
- **文档字符串**: 改进的函数和模块文档
- **日志格式**: 统一的日志格式，包含模块和函数信息
- **错误处理**: 更全面的异常处理和错误报告

### 🔄 向后兼容性
- 保持原有的数据采集逻辑和调度机制
- 保持原有的Webhook通知功能
- 保持原有的状态报告格式


